<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>採購週報 Dashboard v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      :root{ --card:#0b0f17; --muted:#121826; --border:#1f2937; }
      body{ background:#0a0e14; color:#e5e7eb; }
      .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; }
      .btn{ padding:.6rem .9rem; border-radius:.75rem; border:1px solid var(--border); background:#101625; }
      .chip{ padding:2px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
      .green{ background:rgba(16,185,129,.15); color:#10b981; border:1px solid #10b98133; }
      .yellow{ background:rgba(234,179,8,.15); color:#f59e0b; border:1px solid #f59e0b33; }
      .red{ background:rgba(239,68,68,.15); color:#ef4444; border:1px solid #ef444433; }
      .table{ width:100%; border-collapse:collapse; } .table th,.table td{ border-bottom:1px solid var(--border); padding:.6rem .75rem; text-align:left; }
      .table th{ color:#9ca3af; font-weight:600; }
      .muted{ color:#9ca3af; }
      .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem; }
      @media (max-width: 900px){ .grid-2{ grid-template-columns:1fr; } }
      .title{ font-size:1.8rem; font-weight:800; letter-spacing:.3px; }
      .kpi{ font-size:1.6rem; font-weight:800; }
      dialog::backdrop{ background: rgba(0,0,0,.5); }
      /* Report canvas */
      #reportRoot { display:none; padding:32px; font-family: ui-sans-serif, system-ui; }
      #reportRoot .section { margin-bottom: 18px; }
      #reportRoot h1 { font-size: 28px; font-weight:800; margin: 0 0 8px; }
      #reportRoot h2 { font-size: 18px; font-weight:700; margin: 12px 0 6px; }
      #reportRoot .kv { display:flex; gap:12px; flex-wrap:wrap; }
      #reportRoot .kv div { background:#0d1422; border:1px solid #22304a; padding:8px 10px; border-radius:10px; }
      #reportRoot table { width:100%; border-collapse: collapse; }
      #reportRoot th, #reportRoot td { border-bottom:1px solid #22304a; padding:8px; text-align:left; font-size: 12px; }
      #reportRoot .small { font-size: 11px; color:#9ca3af; }
    </style>
  </head>
  <body>
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between mb-6 gap-3 flex-wrap">
        <div>
          <div class="title">採購週報 Dashboard v3</div>
          <div class="muted text-sm">報告產生器｜多資料切換｜自訂 KPI 門檻｜上傳 Excel/CSV</div>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <select id="sourceSelect" class="btn"></select>
          <input id="uploadInput" type="file" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
          <button id="uploadBtn" class="btn">上傳 Excel/CSV</button>
          <select id="buyerSelect" class="btn"></select>
          <input id="weekInput" type="week" class="btn" />
          <input id="topNInput" type="number" min="3" max="20" value="5" class="btn w-28" title="Top N 件數"/>
          <button id="resetBtn" class="btn">重置</button>
          <button id="settingsBtn" class="btn">KPI 設定</button>
          <button id="buildReportBtn" class="btn">生成個人報告</button>
          <button id="exportPDFBtn" class="btn">匯出 PDF</button>
          <button id="exportXLSXBtn" class="btn">匯出 Excel</button>
        </div>
      </div>

      <!-- KPI -->
      <div id="kpiRow" class="grid-2 mb-6">
        <div class="card p-4">
          <div class="muted mb-1">總採購金額</div>
          <div id="kpiAmount" class="kpi">-</div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">達成率 <span class="muted text-xs" id="rateRule"></span></div>
          <div class="flex items-center gap-2">
            <div id="kpiRate" class="kpi">-</div>
            <span id="kpiRateChip" class="chip">-</span>
          </div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">交期達成率 <span class="muted text-xs" id="ontimeRule"></span></div>
          <div class="flex items-center gap-2">
            <div id="kpiOnTime" class="kpi">-</div>
            <span id="kpiOnTimeChip" class="chip">-</span>
          </div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">平均毛利率</div>
          <div id="kpiMargin" class="kpi">-</div>
        </div>
      </div>

      <div class="grid-2 mb-6">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">採購金額（類別）</div>
            <div class="muted text-sm" id="sumByCategoryInfo">—</div>
          </div>
          <canvas id="barByCategory" height="220"></canvas>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">每週採購趨勢</div>
            <div class="muted text-sm" id="trendInfo">—</div>
          </div>
          <canvas id="lineTrend" height="220"></canvas>
        </div>
      </div>

      <div class="card p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">採購 × 商品類別（Pivot）</div>
        </div>
        <div class="overflow-x-auto">
          <table id="pivotTable" class="table"></table>
        </div>
      </div>

      <div class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">原始明細</div>
          <div class="muted text-sm">支援 CSV / Excel 來源</div>
        </div>
        <div class="overflow-x-auto">
          <table id="rawTable" class="table"></table>
        </div>
      </div>
    </div>

    <!-- Settings Dialog -->
    <dialog id="settingsDialog" class="w-full max-w-lg rounded-2xl card p-0">
      <form method="dialog">
        <div class="p-5 border-b border-slate-700">
          <div class="text-lg font-bold">KPI 設定</div>
          <div class="muted text-sm">自訂紅/黃/綠門檻（儲存於 localStorage）</div>
        </div>
        <div class="p-5 grid grid-cols-1 gap-4">
          <div><label class="block text-sm muted mb-1">達成率：綠（≥）</label><input id="rateGreen" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">達成率：黃（≥）</label><input id="rateYellow" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">交期達成率：綠（≥）</label><input id="ontimeGreen" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">交期達成率：黃（≥）</label><input id="ontimeYellow" type="number" step="0.01" class="btn w-full" /></div>
        </div>
        <div class="p-5 flex justify-end gap-3 border-t border-slate-700">
          <button id="settingsCancel" class="btn">取消</button>
          <button id="settingsSave" class="btn">儲存</button>
        </div>
      </form>
    </dialog>

    <!-- Hidden Report Root for PDF composing -->
    <div id="reportRoot"></div>

    <script src="./assets/app.js"></script>
  </body>
</html>
