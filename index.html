<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>採購週報 Dashboard v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      :root{ --card:#0b0f17; --muted:#121826; --border:#1f2937; }
      body{ background:#0a0e14; color:#e5e7eb; }
      .card{ background:var(--card); border:1px solid var(--border); border-radius:1rem; }
      .btn{ padding:.55rem .85rem; border-radius:.6rem; border:1px solid var(--border); background:#101625; }
      .chip{ padding:2px 8px; border-radius:9999px; font-size:12px; font-weight:600; }
      .green{ background:rgba(16,185,129,.15); color:#10b981; border:1px solid #10b98133; }
      .yellow{ background:rgba(234,179,8,.15); color:#f59e0b; border:1px solid #f59e0b33; }
      .red{ background:rgba(239,68,68,.15); color:#ef4444; border:1px solid #ef444433; }
      .table{ width:100%; border-collapse:collapse; } .table th,.table td{ border-bottom:1px solid var(--border); padding:.55rem .7rem; text-align:left; }
      .table th{ color:#9ca3af; font-weight:600; }
      .muted{ color:#9ca3af; }
      .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem; }
      @media (max-width: 900px){ .grid-2{ grid-template-columns:1fr; } }
      .title{ font-size:1.8rem; font-weight:800; letter-spacing:.3px; }
      .kpi{ font-size:1.6rem; font-weight:800; }
      dialog::backdrop{ background: rgba(0,0,0,.5); }
      input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
      input[type="number"]{ -moz-appearance:textfield; }
    </style>
  </head>
  <body>
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between mb-6 gap-3 flex-wrap">
        <div>
          <div class="title">採購週報 Dashboard v3.1</div>
          <div class="muted text-sm">報告產生器｜多資料切換｜自訂 KPI ｜上傳 Excel/CSV｜<b>個人目標/實績填寫</b></div>
        </div>
        <div class="flex items-center gap-2 flex-wrap">
          <select id="sourceSelect" class="btn"></select>
          <input id="uploadInput" type="file" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
          <button id="uploadBtn" class="btn">上傳 Excel/CSV</button>
          <select id="buyerSelect" class="btn"></select>
          <input id="weekInput" type="week" class="btn" />
          <input id="topNInput" type="number" min="3" max="20" value="5" class="btn w-24" title="Top N 件數"/>
          <button id="resetBtn" class="btn">重置</button>
          <button id="settingsBtn" class="btn">KPI 設定</button>
          <button id="planBtn" class="btn">目標/實績填寫</button>
          <button id="buildReportBtn" class="btn">生成個人報告</button>
          <button id="exportPDFBtn" class="btn">匯出 PDF</button>
          <button id="exportXLSXBtn" class="btn">匯出 Excel</button>
        </div>
      </div>

      <!-- KPI -->
      <div id="kpiRow" class="grid-2 mb-6">
        <div class="card p-4">
          <div class="muted mb-1">總採購金額</div>
          <div id="kpiAmount" class="kpi">-</div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">達成率 <span class="muted text-xs" id="rateRule"></span></div>
          <div class="flex items-center gap-2">
            <div id="kpiRate" class="kpi">-</div>
            <span id="kpiRateChip" class="chip">-</span>
          </div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">交期達成率 <span class="muted text-xs" id="ontimeRule"></span></div>
          <div class="flex items-center gap-2">
            <div id="kpiOnTime" class="kpi">-</div>
            <span id="kpiOnTimeChip" class="chip">-</span>
          </div>
        </div>
        <div class="card p-4">
          <div class="muted mb-1">平均毛利率</div>
          <div id="kpiMargin" class="kpi">-</div>
        </div>
      </div>

      <div class="grid-2 mb-6">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">採購金額（類別）</div>
            <div class="muted text-sm" id="sumByCategoryInfo">—</div>
          </div>
          <canvas id="barByCategory" height="220"></canvas>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">每週採購趨勢</div>
            <div class="muted text-sm" id="trendInfo">—</div>
          </div>
          <canvas id="lineTrend" height="220"></canvas>
        </div>
      </div>

      <div class="card p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">採購 × 商品類別（Pivot）</div>
        </div>
        <div class="overflow-x-auto">
          <table id="pivotTable" class="table"></table>
        </div>
      </div>

      <div class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">原始明細</div>
          <div class="muted text-sm">支援 CSV / Excel 來源</div>
        </div>
        <div class="overflow-x-auto">
          <table id="rawTable" class="table"></table>
        </div>
      </div>
    </div>

    <!-- Settings Dialog -->
    <dialog id="settingsDialog" class="w-full max-w-lg rounded-2xl card p-0">
      <form method="dialog">
        <div class="p-5 border-b border-slate-700">
          <div class="text-lg font-bold">KPI 設定</div>
          <div class="muted text-sm">自訂紅/黃/綠門檻（儲存於 localStorage）</div>
        </div>
        <div class="p-5 grid grid-cols-1 gap-4">
          <div><label class="block text-sm muted mb-1">達成率：綠（≥）</label><input id="rateGreen" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">達成率：黃（≥）</label><input id="rateYellow" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">交期達成率：綠（≥）</label><input id="ontimeGreen" type="number" step="0.01" class="btn w-full" /></div>
          <div><label class="block text-sm muted mb-1">交期達成率：黃（≥）</label><input id="ontimeYellow" type="number" step="0.01" class="btn w-full" /></div>
        </div>
        <div class="p-5 flex justify-end gap-3 border-t border-slate-700">
          <button id="settingsCancel" class="btn">取消</button>
          <button id="settingsSave" class="btn">儲存</button>
        </div>
      </form>
    </dialog>

    <!-- Personal Plan Dialog -->
    <dialog id="planDialog" class="w-full max-w-3xl rounded-2xl card p-0">
      <form method="dialog">
        <div class="p-5 border-b border-slate-700 flex items-center justify-between">
          <div>
            <div class="text-lg font-bold">個人目標 / 實績填寫</div>
            <div id="planTitle" class="muted text-sm"></div>
          </div>
          <div class="flex gap-2">
            <button id="planAddRow" class="btn" type="button">新增分類</button>
            <button id="planExport" class="btn" type="button">匯出 CSV</button>
          </div>
        </div>
        <div class="p-5 overflow-x-auto" style="max-height:60vh">
          <table class="table w-full" id="planTable">
            <thead>
              <tr>
                <th style="min-width:160px">產品分類</th>
                <th style="min-width:120px">目標金額</th>
                <th style="min-width:120px">實際金額</th>
                <th style="min-width:100px">達成率</th>
                <th style="min-width:80px">操作</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td><b>合計</b></td>
                <td id="planSumTarget">-</td>
                <td id="planSumActual">-</td>
                <td id="planSumRate">-</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
          <div class="muted text-xs mt-2">提示：目標/實際填入數字（TWD），系統即時計算達成率；資料會儲存在你的瀏覽器（localStorage）。</div>
        </div>
        <div class="p-5 flex justify-end gap-2 border-t border-slate-700">
          <button id="planCancel" class="btn">關閉</button>
          <button id="planSave" class="btn">儲存</button>
        </div>
      </form>
    </dialog>

    <script src="./assets/app.js"></script>
  </body>
</html>
